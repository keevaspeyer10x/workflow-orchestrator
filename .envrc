# Auto-load secrets when entering this directory
# Requires direnv: https://direnv.net/

# Set the age key file location (portable path)
export SOPS_AGE_KEY_FILE="${HOME}/.config/sops/age/keys.txt"

# Check if sops is available and decrypt once (not 5 times!)
SOPS_BIN="${HOME}/.local/bin/sops"
if [ -f "$SOPS_BIN" ] && [ -f "secrets.enc.yaml" ]; then
    # Check if Claude is authenticated (skip ANTHROPIC_API_KEY if so)
    CLAUDE_AUTHENTICATED=false
    if [ -f "$HOME/.claude/.credentials.json" ]; then
        CLAUDE_AUTHENTICATED=true
    fi

    # Decrypt once and cache
    SECRETS_CONTENT=$($SOPS_BIN -d secrets.enc.yaml 2>/dev/null)

    if [ -n "$SECRETS_CONTENT" ]; then
        # Only load ANTHROPIC_API_KEY if Claude is NOT authenticated
        if [ "$CLAUDE_AUTHENTICATED" = false ]; then
            export ANTHROPIC_API_KEY=$(echo "$SECRETS_CONTENT" | grep anthropic_api_key | cut -d: -f2 | tr -d ' ')
        fi

        # Load other API keys (always needed for reviews)
        export GEMINI_API_KEY=$(echo "$SECRETS_CONTENT" | grep gemini_api_key | cut -d: -f2 | tr -d ' ')
        export OPENROUTER_API_KEY=$(echo "$SECRETS_CONTENT" | grep openrouter_api_key | cut -d: -f2 | tr -d ' ')
        export OPENAI_API_KEY=$(echo "$SECRETS_CONTENT" | grep openai_api_key | cut -d: -f2 | tr -d ' ')
        export XAI_API_KEY=$(echo "$SECRETS_CONTENT" | grep grok_api_key | cut -d: -f2 | tr -d ' ')
    fi
fi

# Activate Python venv if it exists
if [ -d "venv" ]; then
    source venv/bin/activate
fi
