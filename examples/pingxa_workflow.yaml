name: "Development Workflow"
version: "2.0"
description: |
  A 6-phase workflow for software development:
  DEFINE → PLAN → EXECUTE → REVIEW → VERIFY → LEARN

  Starts with product definition to ensure clear requirements before planning.
  Calibrates process to task complexity (trivial → complex).

  Use /spec command for guided definition protocol.
  Use 'orchestrator start "[task]" -w define.yaml' for standalone PRD generation.

settings:
  # Settings specific to this workflow
  test_command: "test -f tests/e2e/settings-card-structure.spec.ts"
  # Claude Code is the default executor - only skip for trivial tasks
  default_executor: "claude_code"

phases:
  # ============================================================
  # PHASE 0: DEFINE - Product definition before planning
  # ============================================================
  - id: "DEFINE"
    name: "Product Definition"
    description: |
      Define WHAT we're building before planning HOW.
      Calibrate process to complexity. Require approval before PLAN.
    executor: "claude_code"
    items:
      - id: "assess_complexity"
        name: "Assess Task Complexity"
        description: |
          Evaluate the request to determine appropriate process:

          TRIVIAL (skip DEFINE entirely):
          - Single change, obvious implementation
          - Examples: "Change button color", "Fix typo"
          - → Skip to PLAN phase

          SIMPLE (abbreviated definition):
          - Small feature, clear outcome, 1 journey
          - Examples: "Add export button", "Show user count"
          - → Quick outcome check + show intent + proceed

          MODERATE (standard definition):
          - Medium feature, some ambiguity, 1-2 journeys
          - Examples: "Add dashboard", "Implement notifications"
          - → Run /spec or define workflow

          COMPLEX (full definition):
          - Large feature, multiple journeys, high stakes
          - Examples: "Build auth system", "Add payment flow"
          - → Run full /spec with all critiques

          Communicate: "This looks like a [TIER] task. I recommend [process]."
          Allow user to override.
        required: true
        skippable: false
        verification:
          type: "none"

      - id: "check_existing_spec"
        name: "Check for Existing Specification"
        description: |
          Check if docs/SPEC.md already exists from a prior /spec session.

          If YES: Review it and confirm still valid.
          If NO and MODERATE/COMPLEX: Run /spec or define.yaml workflow.
          If NO and SIMPLE: Do quick inline definition.
          If TRIVIAL: Skip to PLAN.
        required: false
        skippable: true
        skip_conditions:
          - "trivial_task"
        verification:
          type: "file_exists"
          path: "docs/SPEC.md"

      - id: "inline_definition"
        name: "Quick Definition (Simple tasks)"
        description: |
          For SIMPLE tasks without existing spec, do inline definition:

          1. Confirm outcome: "You want [X] so that [Y]. Correct?"
          2. Show intent: "Here's what I'm planning: [artifact]"
          3. Get approval: "Look right?"

          Skip for TRIVIAL (no definition needed) or if spec exists.
        required: false
        skippable: true
        skip_conditions:
          - "trivial_task"
          - "spec_exists"
          - "moderate_or_complex_task"
        verification:
          type: "none"

      - id: "run_full_definition"
        name: "Run Full Definition Process (Moderate/Complex)"
        description: |
          For MODERATE or COMPLEX tasks, run the full definition process.

          Option A: Run /spec slash command (interactive)
          Option B: Run define workflow: orchestrator start "[task]" -w define.yaml

          The definition process covers:
          - Outcome discovery (job-to-be-done)
          - User journey mapping
          - Data requirements
          - Research & patterns
          - Edge cases
          - Design artifact
          - Stakeholder critique

          Output: docs/SPEC.md
        required: false
        skippable: true
        skip_conditions:
          - "trivial_task"
          - "simple_task"
          - "spec_exists"
        verification:
          type: "file_exists"
          path: "docs/SPEC.md"

      - id: "definition_approval"
        name: "Approve Definition"
        description: |
          User approves the product definition before proceeding to PLAN.

          For TRIVIAL: "Got it, proceeding to plan [change]."
          For SIMPLE: "Confirmed: [outcome]. Proceeding to plan."
          For MODERATE/COMPLEX: "Spec approved. Proceeding to plan implementation."

          This gate ensures clear requirements before technical planning.
        required: true
        skippable: true
        skip_conditions:
          - "trivial_task"
        verification:
          type: "manual_gate"
          description: "User approves definition before planning"

  # ============================================================
  # PHASE 1: PLAN - Technical planning and approach
  # ============================================================
  - id: "PLAN"
    name: "Planning & Scoping"
    description: |
      Plan HOW to implement the defined requirements.
      Uses docs/SPEC.md as source of truth if available.
    items:
      - id: "initial_plan"
        name: "Generate initial plan"
        description: "Create a detailed plan of action and save it to docs/plan.md. Include decision on whether to use Claude Code (default: yes) or handle directly (only for trivial tasks)."
        required: true
        skippable: false
        verification:
          type: "file_exists"
          path: "docs/plan.md"

      - id: "risk_analysis"
        name: "Risk & Impact Analysis"
        description: "Document potential risks and their impact in docs/risk_analysis.md"
        required: true
        skippable: true
        skip_conditions: ["simple_bug_fix", "trivial_change"]
        verification:
          type: "file_exists"
          path: "docs/risk_analysis.md"

      - id: "define_test_cases"
        name: "Define Test Cases"
        description: "Outline the test cases that will be used to verify the feature in tests/test_cases.md. For UI changes, include visual/screenshot test cases."
        required: true
        skippable: false
        verification:
          type: "file_exists"
          path: "tests/test_cases.md"

      - id: "user_approval"
        name: "Get User Approval"
        description: "The user must approve the plan before execution can begin."
        required: true
        skippable: false
        verification:
          type: "manual_gate"
          description: "User must run 'orchestrator approve' to proceed."

  - id: "EXECUTE"
    name: "Implementation"
    description: "Write code and tests to implement the planned feature. DEFAULT: Use Claude Code for implementation. Only handle directly for trivial tasks with explicit justification."
    items:
      - id: "handoff_decision"
        name: "Claude Code Handoff Decision"
        description: "Determine if task should be handed off to Claude Code (default) or handled directly. Document reasoning. Only skip Claude Code for: 1) Single-line config changes, 2) Documentation-only updates, 3) Explicit user request to handle directly."
        required: true
        skippable: false

      - id: "write_tests"
        name: "Write tests first"
        description: "Implement the test cases defined in the planning phase. For UI changes, include screenshot/visual regression tests where appropriate."
        required: true
        skippable: false
        verification:
          type: "command"
          command: "{{test_command}}"
          expect_exit_code: 0

      - id: "implement_code"
        name: "Implement feature code"
        description: "Write the application code that satisfies the requirements. Use Claude Code unless explicitly decided otherwise in handoff_decision."
        required: true
        skippable: false

      - id: "all_tests_pass"
        name: "Ensure all tests pass"
        description: "Run the test suite and ensure all tests pass after implementation."
        required: true
        skippable: false
        verification:
          type: "command"
          command: "{{test_command}}"
          expect_exit_code: 0

  - id: "REVIEW"
    name: "Code & Architecture Review"
    description: "Perform multi-agent review of the code against best practices. Use different agent/model than the one that wrote the code."
    items:
      - id: "security_review"
        name: "Security Review"
        description: "Check for common security vulnerabilities (e.g., OWASP Top 10)."
        required: true
        skippable: true

      - id: "architecture_review"
        name: "Architecture Review"
        description: "Ensure the implementation aligns with the project's architecture."
        required: true
        skippable: true

      - id: "quality_review"
        name: "Code Quality Review"
        description: "Check for code smells, readability, and maintainability."
        required: true
        skippable: true

  - id: "VERIFY"
    name: "Final Verification"
    description: "Perform final checks to ensure the feature is ready for release."
    items:
      - id: "full_test_suite"
        name: "Run full test suite again"
        description: "Ensure no regressions were introduced during review."
        required: true
        skippable: false
        verification:
          type: "command"
          command: "{{test_command}}"
          expect_exit_code: 0

      - id: "visual_regression_test"
        name: "Visual/Screenshot Regression Test"
        description: "For UI changes: capture screenshots and compare against baseline. Verify no unintended visual changes."
        required: true
        skippable: true
        skip_conditions: ["no_ui_changes", "backend_only"]

      - id: "manual_smoke_test"
        name: "Manual Smoke Test"
        description: "Manually test the core functionality to ensure it works as expected. Use test credentials from .env (TEST_EMAIL, TEST_PASSWORD)."
        required: true
        skippable: true
        verification:
          type: "manual_gate"
          description: "User to confirm manual smoke test passed."

  - id: "LEARN"
    name: "Learning & Documentation"
    description: "Document learnings and update knowledge base. Learnings must be approved before being embedded in the process."
    items:
      - id: "root_cause_analysis"
        name: "Root Cause Analysis"
        description: "MANDATORY: Perform and document root cause analysis. Why did this issue occur? What was the underlying cause, not just the symptom? Document in LEARNINGS.md."
        required: true
        skippable: false

      - id: "document_learnings"
        name: "Document Learnings"
        description: "Create or update LEARNINGS.md with: 1) Problem summary, 2) Root cause analysis, 3) Fix applied, 4) Systemic insights (broader implications), 5) Prevention measures, 6) Audit recommendations."
        required: true
        skippable: false
        verification:
          type: "file_exists"
          path: "LEARNINGS.md"

      - id: "approve_learnings"
        name: "User Approval of Learnings"
        description: "User must review and approve the documented learnings before they are committed. This ensures learnings are accurate, complete, and valuable for future reference."
        required: true
        skippable: false
        verification:
          type: "manual_gate"
          description: "User must review LEARNINGS.md and run 'orchestrator approve-item approve_learnings' to confirm learnings are correct and complete."

      - id: "update_knowledge_base"
        name: "Update Knowledge Base"
        description: "Update any relevant project documentation or knowledge base with approved learnings."
        required: false
        skippable: true
